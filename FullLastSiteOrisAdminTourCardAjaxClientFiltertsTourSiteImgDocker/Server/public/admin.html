<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Админ-панель — You Travel Me</title>
<style>
  body {
    margin: 0; background: #f4f6f9; font-family: 'Segoe UI', sans-serif; color: #333;
  }
  .header {
    background: var(--dark); color: white; padding: 24px 40px; font-size: 26px; font-weight: 700;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }
  .container { max-width: 1400px; margin: 40px auto; padding: 0 20px; }
  .panel {
    background: white; border-radius: 16px; padding: 32px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  }
  .controls {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
  }
  .btn {
    padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer;
    font-weight: 600; font-size: 15px; transition: all 0.2s;
  }
  .btn-add { background: var(--success); color: white; }
  .btn-add:hover { background: #219653; transform: translateY(-2px); }
  .stats {
    color: var(--primary); font-size: 18px; font-weight: 600;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14.5px;
  }
  th {
    background: var(--primary); color: white; padding: 16px; text-align: left;
  }
  td { padding: 14px; border-bottom: 1px solid #eee; }
  tr:hover { background: #f8fbff; }
  .actions button {
    padding: 8px 14px; margin-right: 6px; font-size: 13px;
  }
  .btn-edit { background: var(--warning); color: white; }
  .btn-delete { background: var(--danger); color: white; }

  .modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center;
  }
  .modal-content {
    background: white; padding: 32px; border-radius: 16px; width: 600px; max-height: 90vh;
    overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .close { float: right; font-size: 32px; cursor: pointer; color: #aaa; }
  .close:hover { color: #000; }
  .form-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 18px;
  }
  .form-group { margin-bottom: 18px; }
  label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); }
  input, textarea, select {
    width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;
  }
  textarea { height: 100px; resize: vertical; }
  .full-width { grid-column: 1 / -1; }
  .form-actions {
    margin-top: 30px; text-align: right;
  }
  .btn-save { background: var(--primary); color: white; padding: 14px 32px; }
  .btn-cancel { background: #95a5a6; color: white; margin-right: 12px; }
</style>
</head>
<body>

<div class="header">
  Админ-панель — Управление турами
</div>

<div class="container">
  <div class="panel">
    <div class="controls">
      <button class="btn btn-add" onclick="openModal()">Добавить тур</button>
      <div class="stats">Всего туров: <span id="totalCount">0</span></div>
    </div>

    <table id="toursTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Название</th>
          <th>Страна</th>
          <th>Цена</th>
          <th>Скидка</th>
          <th>Дней</th>
          <th>Рейтинг</th>
          <th>Фото</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody id="toursBody"></tbody>
    </table>
  </div>
</div>


<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle">Добавить тур</h2>
    <form id="tourForm">
      <input type="hidden" id="id">

      <div class="form-grid">
        <div class="form-group">
          <label>Название тура</label>
          <input type="text" id="title" required>
        </div>
        <div class="form-group">
          <label>Страна</label>
          <input type="text" id="country" required>
        </div>

        <div class="form-group full-width">
          <label>Краткое описание</label>
          <textarea id="description" required></textarea>
        </div>

        <div class="form-group">
          <label>Цена (₽)</label>
          <input type="number" id="price" required>
        </div>
        <div class="form-group">
          <label>Скидка (₽)</label>
          <input type="number" id="discount">
        </div>

        <div class="form-group">
          <label>Дней</label>
          <input type="number" id="days" required>
        </div>
        <div class="form-group">
          <label>Ночей</label>
          <input type="number" id="nights" required>
        </div>

        <div class="form-group">
          <label>Комфорт (1–5)</label>
          <input type="number" id="comfortLevel" min="1" max="5" value="4">
        </div>
        <div class="form-group">
          <label>Активность (1–5)</label>
          <input type="number" id="activityLevel" min="1" max="5" value="3">
        </div>

        <div class="form-group">
          <label>Рейтинг</label>
          <input type="text" id="rating" value="5.0">
        </div>
        <div class="form-group">
          <label>Отзывов</label>
          <input type="number" id="reviewsCount" value="0">
        </div>

        <div class="form-group full-width">
          <label>Путь к главному фото (например: images/tour1.jpg)</label>
          <input type="text" id="imagePath" placeholder="images/safari.jpg">
        </div>

        <div class="form-group">
          <label>Порядок (sort_order)</label>
          <input type="number" id="sortOrder" value="0">
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeModal()">Отмена</button>
        <button type="submit" class="btn btn-save">Сохранить тур</button>
      </div>
    </form>
  </div>
</div>

<script>
async function loadTours() {
  const res = await fetch('/admin-api/tours');
  const tours = await res.json();
  document.getElementById('totalCount').textContent = tours.length;

  document.getElementById('toursBody').innerHTML = tours.map(t => `
    <tr>
      <td>${t.id}</td>
      <td><strong>${t.title}</strong></td>
      <td>${t.country}</td>
      <td>₽ ${t.price.toLocaleString()}</td>
      <td>${t.discount ? '₽ ' + t.discount.toLocaleString() : '—'}</td>
      <td>${t.days}</td>
      <td>${t.rating} (${t.reviewsCount})</td>
      <td>${t.imagePath ? 'есть' : 'нет'}</td>
      <td class="actions">
        <button class="btn btn-edit" onclick='editTour(${JSON.stringify(t)})'>Изменить</button>
        <button class="btn btn-delete" onclick="deleteTour(${t.id})">Удалить</button>
      </td>
    </tr>
  `).join('');
}

function openModal(tour = null) {
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modalTitle').textContent = tour ? 'Редактировать тур' : 'Добавить тур';
  if (tour) {
    Object.keys(tour).forEach(k => {
      const el = document.getElementById(k.replace(/([A-Z])/g, m => m.toLowerCase()));
      if (el) el.value = tour[k] ?? '';
    });
    document.getElementById('sortorder').value = tour.sortOrder;
  } else {
    document.getElementById('tourForm').reset();
    document.getElementById('id').value = '';
  }
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function editTour(tour) {
  tour.comfortLevel = tour.comfortLevel;
  tour.activityLevel = tour.activityLevel;
  tour.reviewsCount = tour.reviewsCount;
  tour.imagePath = tour.imagePath;
  tour.sortOrder = tour.sortOrder;
  openModal(tour);
}

document.getElementById('tourForm').onsubmit = async e => {
  e.preventDefault();
  const form = e.target;
  const data = {
    id: +form.id.value || null,
    title: form.title.value,
    country: form.country.value,
    description: form.description.value,
    price: +form.price.value,
    discount: form.discount.value ? +form.discount.value : null,
    days: +form.days.value,
    nights: +form.nights.value,
    comfortLevel: +form.comfortLevel.value,
    activityLevel: +form.activityLevel.value,
    rating: form.rating.value,
    reviewsCount: +form.reviewsCount.value,
    imagePath: form.imagePath.value || null,
    sortOrder: +form.sortOrder.value || 0
  };

  const method = data.id ? 'PUT' : 'POST';
  const url = data.id ? `/admin-api/tours/${data.id}` : '/admin-api/tours';

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  closeModal();
  loadTours();
};

async function deleteTour(id) {
  if (confirm('Удалить тур навсегда?')) {
    await fetch(`/admin-api/tours/${id}`, { method: 'DELETE' });
    loadTours();
  }
}

loadTours();
</script>
</body>
</html>